<!-- Custom Templates -->
<ng-template #dateTemplate let-row>
    {{ parseDate(row?.date) | date:'MM/dd/yyyy' }}
</ng-template>

<div class="budget-tracker">
    <!-- Budget Summary Cards -->
    <div class="summary-cards">
        <div class="summary-card total">
            <div class="card-icon">
                <span class="material-icons">account_balance_wallet</span>
            </div>
            <div class="card-content">
                <span class="label">Total Budget</span>
                <div class="value-container" *ngIf="!isEditingBudget()">
                    <span class="value">{{ formatCurrency(budget().totalBudget) }}</span>
                    <button class="btn-icon-small" (click)="toggleEditBudget()">
                        <span class="material-icons">edit</span>
                    </button>
                </div>
                <div class="edit-container" *ngIf="isEditingBudget()">
                    <input type="number" #budgetInput [value]="budget().totalBudget" class="budget-input">
                    <button class="btn-icon-small success" (click)="saveTotalBudget(budgetInput.value)">
                        <span class="material-icons">check</span>
                    </button>
                    <button class="btn-icon-small danger" (click)="toggleEditBudget()">
                        <span class="material-icons">close</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="summary-card spent">
            <div class="card-icon">
                <span class="material-icons">payments</span>
            </div>
            <div class="card-content">
                <span class="label">Total Spent</span>
                <span class="value">{{ formatCurrency(totalSpent()) }}</span>
                <span class="percentage">{{ budgetPercentage() }}% of budget</span>
            </div>
        </div>

        <div class="summary-card remaining" [class.warning]="budgetPercentage() > 80"
            [class.danger]="budgetPercentage() > 95">
            <div class="card-icon">
                <span class="material-icons">savings</span>
            </div>
            <div class="card-content">
                <span class="label">Remaining</span>
                <span class="value">{{ formatCurrency(totalRemaining()) }}</span>
                <span class="percentage">{{ 100 - budgetPercentage() }}% left</span>
            </div>
        </div>
    </div>
    <br>
    <!-- Budget Progress Bar -->
    <div class="progress-section">
        <div class="progress-header">
            <h3>Budget Utilization</h3>
            <span class="progress-label">{{ budgetPercentage() }}%</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="budgetPercentage()" [class.warning]="budgetPercentage() > 80"
                [class.danger]="budgetPercentage() > 95">
            </div>
        </div>
    </div>

    <!-- Category Breakdown -->
    <div class="category-section">
        <div class="section-header">
            <h3 class="section-title">Budget by Category</h3>
            <button class="btn-manage" (click)="openAddCategoryForm()">
                <span class="material-icons">add</span>
                Manage Categories
            </button>
        </div>

        <!-- Empty state when no categories -->
        <div class="empty-state" *ngIf="!hasCategories()">
            <span class="material-icons">category</span>
            <p>No categories added yet</p>
            <p class="empty-subtitle">Create categories to organize your budget</p>
            <button class="btn-primary" (click)="openAddCategoryForm()">
                <span class="material-icons">add</span>
                Add Your First Category
            </button>
        </div>

        <!-- Category cards -->
        <div class="category-grid" *ngIf="hasCategories()">
            <div class="category-card" *ngFor="let category of budget().categories">
                <div class="category-header">
                    <div class="category-info">
                        <span class="material-icons" [style.color]="category.color">{{ category.icon }}</span>
                        <span class="category-name">{{ category.name }}</span>
                    </div>
                    <div class="category-actions">
                        <button class="btn-icon-sm" (click)="openEditCategoryForm(category)" title="Edit category">
                            <span class="material-icons">edit</span>
                        </button>
                        <button class="btn-icon-sm danger" (click)="deleteCategory(category)" title="Delete category">
                            <span class="material-icons">delete</span>
                        </button>
                    </div>
                </div>
                <div class="category-amounts">
                    <span class="spent">{{ formatCurrency(getCategorySpent(category._id)) }}</span>
                    <span class="allocated">of {{ formatCurrency(category.allocatedAmount) }}</span>
                </div>
                <div class="category-progress">
                    <div class="category-progress-fill" [style.width.%]="getCategorySpentPercentage(category._id)"
                        [style.background-color]="category.color">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Expenses Section -->
    <div class="expenses-section">
        <div class="expenses-header">
            <h3 class="section-title">Expense Details</h3>
            <div class="filters">
                <select [(ngModel)]="selectedCategory"
                    (change)="selectedCategory.set($any($event.target).value || null)" class="filter-select">
                    <option [value]="null">All Categories</option>
                    <option *ngFor="let category of budget().categories" [value]="category._id">
                        {{ category.name }}
                    </option>
                </select>
                <select [(ngModel)]="selectedStatus" (change)="selectedStatus.set($any($event.target).value || null)"
                    class="filter-select">
                    <option [value]="null">All Status</option>
                    <option value="paid">Paid</option>
                    <option value="pending">Pending</option>
                    <option value="overdue">Overdue</option>
                </select>
                <button class="btn-clear" (click)="clearFilters()" *ngIf="selectedCategory() || selectedStatus()">
                    Clear Filters
                </button>
            </div>
            <div class="actions">
                <button class="btn-add" (click)="openAddExpenseForm()" [disabled]="!hasCategories()"
                    [title]="!hasCategories() ? 'Please add categories first' : 'Add a new expense'">
                    <span class="material-icons">add</span>
                    Add Expense
                </button>
            </div>
        </div>





        <!-- Expenses Table with Actions -->
        <div class="expenses-table">
            <app-data-table [data]="filteredExpenses()" [columns]="tableColumns" [config]="tableConfig"
                [actions]="tableActions" (action)="handleTableAction($event)">
            </app-data-table>
        </div>
    </div>
    <br>
    <!-- Budget Analysis Charts -->
    <div class="charts-section" *ngIf="hasCategories()">
        <h3 class="section-title">Budget Analysis</h3>
        <div class="charts-grid">
            <app-budget-chart title="Spending Breakdown" type="doughnut" [data]="spendingChartData()"
                [options]="doughnutOptions" [centerLabel]="'Total Spent'" [centerValue]="formatCurrency(totalSpent())"
                [showCustomLegend]="true">
            </app-budget-chart>

            <app-budget-chart title="Allocated vs Spent" type="bar" [data]="budgetComparisonData()"
                [options]="barOptions">
            </app-budget-chart>

            <app-budget-chart *ngIf="expenses().length > 0" title="Spending Trend" type="line"
                [data]="spendingTrendData()" [options]="lineOptions">
            </app-budget-chart>
        </div>
    </div>

    <!-- Expense Form Modal -->
    <div class="modal-overlay" *ngIf="showExpenseForm()" (click)="cancelExpenseForm()">
        <div class="modal-container" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h4>{{ editingExpense() ? 'Edit Expense' : 'Add New Expense' }}</h4>
                <button class="btn-close" (click)="cancelExpenseForm()">
                    <span class="material-icons">close</span>
                </button>
            </div>

            <div class="modal-body" [formGroup]="form">
                <div class="expense-form-content">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Category *</label>
                            <select formControlName="categoryId">
                                <option value="">Select Category</option>
                                <option *ngFor="let category of budget().categories" [value]="category._id">
                                    {{ category.name }}
                                </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Description *</label>
                            <input type="text" formControlName="description" placeholder="Enter expense description">
                        </div>
                        <div class="form-group">
                            <label>Vendor *</label>
                            <input type="text" formControlName="vendor" placeholder="Enter vendor name">
                        </div>
                        <div class="form-group">
                            <label>Amount *</label>
                            <input type="number" formControlName="amount" placeholder="0.00" step="0.01" min="0.01">
                        </div>
                        <div class="form-group">
                            <label>Date *</label>
                            <input type="text" formControlName="date" placeholder="MM/DD/YYYY">
                        </div>
                        <div class="form-group">
                            <label>Status *</label>
                            <select formControlName="status">
                                <option value="pending">Pending</option>
                                <option value="paid">Paid</option>
                                <option value="overdue">Overdue</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea formControlName="notes" rows="3" placeholder="Additional notes (optional)"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-cancel" (click)="cancelExpenseForm()">Cancel</button>
                        <button type="button" class="btn-save" (click)="saveExpense()">
                            {{ editingExpense() ? 'Update' : 'Add' }} Expense
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Form Modal -->
    <app-category-form *ngIf="showCategoryForm()" [budgetId]="budget()._id" [category]="editingCategory()"
        (saved)="handleCategorySaved()" (cancelled)="closeCategoryForm()">
    </app-category-form>
</div>